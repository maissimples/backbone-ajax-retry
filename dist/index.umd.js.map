{"version":3,"file":"index.umd.js","sources":["../src/linearDelay.ts","../src/hasRetryableStatus.ts","../src/JQueryXHR.ts","../src/createAjaxWithRetry.ts","../src/createSyncWithRetry.ts","../src/setupBackboneAjaxRetry.ts"],"sourcesContent":["import type { BackboneAjaxRetryDelay } from './types';\n\nfunction linearDelay(delayFactor: number = 100): BackboneAjaxRetryDelay {\n  return (retry: number): number => retry * delayFactor;\n}\n\nexport default linearDelay;\n","/** Both `Too Many Requests` and `Request Timeout` statuses are retryable. */\nconst RETRYABLE_STATUSES = [408, 429];\n\n/** Checks if jQuery ajax returns a response with a retryable status. */\nfunction hasRetryableStatus(jqXHR: JQueryXHR): boolean {\n  return (\n    RETRYABLE_STATUSES.includes(jqXHR.status) ||\n    (jqXHR.status >= 500 && jqXHR.status <= 599)\n  );\n}\n\nexport default hasRetryableStatus;\n","/* eslint @typescript-eslint/no-explicit-any: off */\n\nimport $ from 'jquery';\n\ntype JQueryXHRStatic<T> = Omit<JQuery.jqXHR<T>, keyof JQuery.Promise<any>>;\n\nfunction createGetterDescriptor<T>(get: () => T): PropertyDescriptor {\n  return {\n    get,\n    enumerable: true,\n    configurable: true,\n  };\n}\n\nexport type JQueryXHRAsProxyOptions<T = any> = {\n  context: { jqXHR: JQuery.jqXHR<T> };\n  onAbort: (statusText?: string) => void;\n  onError: (\n    this: JQuery.AjaxSettings,\n    jqXHR: JQuery.jqXHR<T>,\n    status: JQuery.Ajax.ErrorTextStatus,\n    statusText: string,\n  ) => JQuery.Promise<any>;\n};\n\nclass JQueryXHR {\n  static asProxy<T>(options: JQueryXHRAsProxyOptions<T>): JQuery.jqXHR<T> {\n    const { context, onAbort, onError } = options;\n\n    const jqXHR = Object.assign(context.jqXHR.catch(onError), {\n      abort: onAbort,\n      getAllResponseHeaders: (): string => {\n        return context.jqXHR.getAllResponseHeaders() ?? '';\n      },\n      getResponseHeader: (name: string): string | null => {\n        return context.jqXHR.getResponseHeader(name) ?? null;\n      },\n      overrideMimeType: (mime: string) => {\n        context.jqXHR.overrideMimeType(mime);\n      },\n      setRequestHeader: (name: string, value: string) => {\n        context.jqXHR.setRequestHeader(name, value);\n      },\n      statusCode: (map: JQuery.Ajax.StatusCodeCallbacks<any>) => {\n        context.jqXHR.statusCode(map);\n      },\n    }) as Partial<JQuery.jqXHR<T>>;\n\n    Object.defineProperties(jqXHR, {\n      readyState: createGetterDescriptor(() => context.jqXHR.readyState),\n      responseText: createGetterDescriptor(() => context.jqXHR.responseText),\n      responseXML: createGetterDescriptor(() => context.jqXHR.responseXML),\n      responseJSON: createGetterDescriptor(() => context.jqXHR.responseJSON),\n      status: createGetterDescriptor(() => context.jqXHR.status),\n      statusText: createGetterDescriptor(() => context.jqXHR.statusText),\n    });\n\n    return jqXHR as JQuery.jqXHR<T>;\n  }\n\n  static asAborted<T>(settings: JQueryAjaxSettings): JQuery.jqXHR<T> {\n    const deferred = $.Deferred<any>();\n\n    const jqXHR = deferred.promise<JQueryXHRStatic<T>>({\n      status: 0,\n      statusText: 'abort',\n      abort: $.noop,\n      statusCode: $.noop,\n      getResponseHeader: () => null,\n      getAllResponseHeaders: () => '',\n      readyState: 0,\n      responseText: '',\n      overrideMimeType: $.noop,\n      setRequestHeader: $.noop,\n    });\n\n    deferred.rejectWith(settings, [jqXHR, 'abort', 'abort']);\n\n    return jqXHR as JQuery.jqXHR<T>;\n  }\n}\n\nexport default JQueryXHR;\n","/* eslint @typescript-eslint/no-explicit-any: 'off' */\n\nimport JQueryXHR from './JQueryXHR';\nimport type { Backbone, BackboneAjax } from './types';\n\ntype TimeoutId = ReturnType<typeof setTimeout>;\n\ntype Context<T = any> = {\n  delay?: {\n    timeoutId: TimeoutId;\n    deferred: JQuery.Deferred<any>;\n  };\n  jqXHR: JQuery.jqXHR<T>;\n  settings: JQueryAjaxSettings;\n};\n\nfunction createAjaxWithRetry(backbone: Backbone): BackboneAjax {\n  const ORIGINAL_AJAX = backbone.ajax;\n\n  return (settings = {}) => {\n    const context: Context = {\n      jqXHR: ORIGINAL_AJAX.call(backbone, settings),\n      settings,\n    };\n\n    function handleError(\n      this: JQuery.AjaxSettings,\n      jqXHR: JQuery.jqXHR,\n      status: JQuery.Ajax.ErrorTextStatus,\n      statusText: string,\n    ): JQuery.jqXHR | JQuery.Deferred<any> {\n      // We ensure 'tries' are defined using an '$.ajaxFilter' in the setup.\n      const tries = this.tries!;\n      const retries = settings.retries ?? backbone.retry.retries;\n      const skipRetryOnCreate = !this.backbone?.model?.retryOnCreate;\n      const methodIsCreate = this.backbone?.sync?.method === 'create';\n\n      const skipRetry =\n        tries > retries ||\n        (skipRetryOnCreate && methodIsCreate) ||\n        !backbone.retry.condition(\n          jqXHR,\n          this.backbone?.model,\n          this.backbone?.sync?.method,\n        );\n\n      const deferred = backbone.$.Deferred();\n\n      if (skipRetry)\n        return deferred.rejectWith(this, [jqXHR, status, statusText]);\n\n      const timeoutId = setTimeout(\n        () => {\n          delete context.delay;\n          context.jqXHR = ORIGINAL_AJAX.call(backbone, this);\n          deferred.resolve(\n            JQueryXHR.asProxy<any>({\n              context,\n              onAbort: handleAbort,\n              onError: handleError,\n            }),\n          );\n        },\n        backbone.retry.delay(tries, jqXHR),\n      );\n\n      context.settings = this;\n      context.delay = { deferred, timeoutId };\n\n      this.tries = tries + 1;\n\n      return deferred;\n    }\n\n    function handleAbort(statusText?: string) {\n      if (!context.delay) {\n        context.jqXHR.abort(statusText);\n        return;\n      }\n\n      const { deferred, timeoutId } = context.delay;\n\n      delete context.delay;\n      clearTimeout(timeoutId);\n      deferred.rejectWith(context.settings, [\n        JQueryXHR.asAborted(context.settings),\n        'abort',\n        'abort',\n      ]);\n    }\n\n    return JQueryXHR.asProxy<any>({\n      context,\n      onError: handleError,\n      onAbort: handleAbort,\n    });\n  };\n}\n\nexport default createAjaxWithRetry;\n","import type { Backbone, BackboneSync } from './types';\n\nfunction createSyncWithRetry(backbone: Backbone): BackboneSync {\n  const ORIGINAL_SYNC = backbone.sync;\n\n  return function (this: Backbone, method, model, settings = {}) {\n    return ORIGINAL_SYNC.call(this, method, model, {\n      ...settings,\n      retries: settings.retries ?? model.retries,\n      backbone: {\n        model,\n        sync: { method },\n      },\n    });\n  };\n}\n\nexport default createSyncWithRetry;\n","import type { Backbone, BackboneAjaxRetrySettings } from './types';\nimport linearDelay from './linearDelay';\nimport hasRetryableStatus from './hasRetryableStatus';\nimport createAjaxWithRetry from './createAjaxWithRetry';\nimport createSyncWithRetry from './createSyncWithRetry';\n\nfunction setupBackboneAjaxRetry(\n  backbone: Backbone,\n  settings?: BackboneAjaxRetrySettings,\n): void {\n  backbone.retry = {\n    delay: settings?.delay ?? linearDelay(200),\n    retries: settings?.retries ?? 3,\n    condition: settings?.condition ?? hasRetryableStatus,\n  };\n\n  backbone.$.ajaxPrefilter((settings) => {\n    // Assigns as the first try when it doesn't have 'tries' number.\n    settings.tries ??= 1;\n  });\n\n  backbone.ajax = createAjaxWithRetry(backbone);\n\n  backbone.sync = createSyncWithRetry(backbone);\n}\n\nexport default setupBackboneAjaxRetry;\n"],"names":[],"mappings":"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"}