{"version":3,"file":"index.esm.js","sources":["../src/linearDelay.ts","../src/hasRetryableStatus.ts","../src/JQueryXHR.ts","../src/createAjaxWithRetry.ts","../src/createSyncWithRetry.ts","../src/setupBackboneAjaxRetry.ts"],"sourcesContent":["import type { BackboneAjaxRetryDelay } from './types';\n\nfunction linearDelay(delayFactor: number = 100): BackboneAjaxRetryDelay {\n  return (retry: number): number => retry * delayFactor;\n}\n\nexport default linearDelay;\n","/** Both `Too Many Requests` and `Request Timeout` statuses are retryable. */\nconst RETRYABLE_STATUSES = [408, 429];\n\n/** Checks if jQuery ajax returns a response with a retryable status. */\nfunction hasRetryableStatus(jqXHR: JQueryXHR): boolean {\n  return (\n    RETRYABLE_STATUSES.includes(jqXHR.status) ||\n    (jqXHR.status >= 500 && jqXHR.status <= 599)\n  );\n}\n\nexport default hasRetryableStatus;\n","/* eslint @typescript-eslint/no-explicit-any: off */\n\nimport $ from 'jquery';\n\ntype JQueryXHRStatic<T> = Omit<JQuery.jqXHR<T>, keyof JQuery.Promise<any>>;\n\nfunction createGetterDescriptor<T>(get: () => T): PropertyDescriptor {\n  return {\n    get,\n    enumerable: true,\n    configurable: true,\n  };\n}\n\nexport type JQueryXHRAsProxyOptions<T = any> = {\n  context: { jqXHR: JQuery.jqXHR<T> };\n  onAbort: (statusText?: string) => void;\n  onError: (\n    this: JQuery.AjaxSettings,\n    jqXHR: JQuery.jqXHR<T>,\n    status: JQuery.Ajax.ErrorTextStatus,\n    statusText: string,\n  ) => JQuery.Promise<any>;\n};\n\nclass JQueryXHR {\n  static asProxy<T>(options: JQueryXHRAsProxyOptions<T>): JQuery.jqXHR<T> {\n    const { context, onAbort, onError } = options;\n\n    const jqXHR = Object.assign(context.jqXHR.catch(onError), {\n      abort: onAbort,\n      getAllResponseHeaders: (): string => {\n        return context.jqXHR.getAllResponseHeaders() ?? '';\n      },\n      getResponseHeader: (name: string): string | null => {\n        return context.jqXHR.getResponseHeader(name) ?? null;\n      },\n      overrideMimeType: (mime: string) => {\n        context.jqXHR.overrideMimeType(mime);\n      },\n      setRequestHeader: (name: string, value: string) => {\n        context.jqXHR.setRequestHeader(name, value);\n      },\n      statusCode: (map: JQuery.Ajax.StatusCodeCallbacks<any>) => {\n        context.jqXHR.statusCode(map);\n      },\n    }) as Partial<JQuery.jqXHR<T>>;\n\n    Object.defineProperties(jqXHR, {\n      readyState: createGetterDescriptor(() => context.jqXHR.readyState),\n      responseText: createGetterDescriptor(() => context.jqXHR.responseText),\n      responseXML: createGetterDescriptor(() => context.jqXHR.responseXML),\n      responseJSON: createGetterDescriptor(() => context.jqXHR.responseJSON),\n      status: createGetterDescriptor(() => context.jqXHR.status),\n      statusText: createGetterDescriptor(() => context.jqXHR.statusText),\n    });\n\n    return jqXHR as JQuery.jqXHR<T>;\n  }\n\n  static asAborted<T>(settings: JQueryAjaxSettings): JQuery.jqXHR<T> {\n    const deferred = $.Deferred<any>();\n\n    const jqXHR = deferred.promise<JQueryXHRStatic<T>>({\n      status: 0,\n      statusText: 'abort',\n      abort: $.noop,\n      statusCode: $.noop,\n      getResponseHeader: () => null,\n      getAllResponseHeaders: () => '',\n      readyState: 0,\n      responseText: '',\n      overrideMimeType: $.noop,\n      setRequestHeader: $.noop,\n    });\n\n    deferred.rejectWith(settings, [jqXHR, 'abort', 'abort']);\n\n    return jqXHR as JQuery.jqXHR<T>;\n  }\n}\n\nexport default JQueryXHR;\n","/* eslint @typescript-eslint/no-explicit-any: 'off' */\n\nimport JQueryXHR from './JQueryXHR';\nimport type { Backbone, BackboneAjax } from './types';\n\ntype TimeoutId = ReturnType<typeof setTimeout>;\n\ntype Context<T = any> = {\n  delay?: {\n    timeoutId: TimeoutId;\n    deferred: JQuery.Deferred<any>;\n  };\n  jqXHR: JQuery.jqXHR<T>;\n  settings: JQueryAjaxSettings;\n};\n\nfunction createAjaxWithRetry(backbone: Backbone): BackboneAjax {\n  const ORIGINAL_AJAX = backbone.ajax;\n\n  return (settings = {}) => {\n    const context: Context = {\n      jqXHR: ORIGINAL_AJAX.call(backbone, settings),\n      settings,\n    };\n\n    function handleError(\n      this: JQuery.AjaxSettings,\n      jqXHR: JQuery.jqXHR,\n      status: JQuery.Ajax.ErrorTextStatus,\n      statusText: string,\n    ): JQuery.jqXHR | JQuery.Deferred<any> {\n      // We ensure 'tries' are defined using an '$.ajaxFilter' in the setup.\n      const tries = this.tries!;\n      const retries = settings.retries ?? backbone.retry.retries;\n      const skipRetryOnCreate = !this.backbone?.model?.retryOnCreate;\n      const methodIsCreate = this.backbone?.sync?.method === 'create';\n\n      const skipRetry =\n        tries > retries ||\n        (skipRetryOnCreate && methodIsCreate) ||\n        !backbone.retry.condition(\n          jqXHR,\n          this.backbone?.model,\n          this.backbone?.sync?.method,\n        );\n\n      const deferred = backbone.$.Deferred();\n\n      if (skipRetry)\n        return deferred.rejectWith(this, [jqXHR, status, statusText]);\n\n      const timeoutId = setTimeout(\n        () => {\n          delete context.delay;\n          context.jqXHR = ORIGINAL_AJAX.call(backbone, this);\n          deferred.resolve(\n            JQueryXHR.asProxy<any>({\n              context,\n              onAbort: handleAbort,\n              onError: handleError,\n            }),\n          );\n        },\n        backbone.retry.delay(tries, jqXHR),\n      );\n\n      context.settings = this;\n      context.delay = { deferred, timeoutId };\n\n      this.tries = tries + 1;\n\n      return deferred;\n    }\n\n    function handleAbort(statusText?: string) {\n      if (!context.delay) {\n        context.jqXHR.abort(statusText);\n        return;\n      }\n\n      const { deferred, timeoutId } = context.delay;\n\n      delete context.delay;\n      clearTimeout(timeoutId);\n      deferred.rejectWith(context.settings, [\n        JQueryXHR.asAborted(context.settings),\n        'abort',\n        'abort',\n      ]);\n    }\n\n    return JQueryXHR.asProxy<any>({\n      context,\n      onError: handleError,\n      onAbort: handleAbort,\n    });\n  };\n}\n\nexport default createAjaxWithRetry;\n","import type { Backbone, BackboneSync } from './types';\n\nfunction createSyncWithRetry(backbone: Backbone): BackboneSync {\n  const ORIGINAL_SYNC = backbone.sync;\n\n  return function (this: Backbone, method, model, settings = {}) {\n    settings.retries = settings.retries ?? model.retries;\n\n    settings.backbone = {\n      model,\n      sync: { method },\n    };\n\n    return ORIGINAL_SYNC.call(this, method, model, settings);\n  };\n}\n\nexport default createSyncWithRetry;\n","import type { Backbone, BackboneAjaxRetrySettings } from './types';\nimport linearDelay from './linearDelay';\nimport hasRetryableStatus from './hasRetryableStatus';\nimport createAjaxWithRetry from './createAjaxWithRetry';\nimport createSyncWithRetry from './createSyncWithRetry';\n\nfunction setupBackboneAjaxRetry(\n  backbone: Backbone,\n  settings?: BackboneAjaxRetrySettings,\n): void {\n  backbone.retry = {\n    delay: settings?.delay ?? linearDelay(200),\n    retries: settings?.retries ?? 3,\n    condition: settings?.condition ?? hasRetryableStatus,\n  };\n\n  backbone.$.ajaxPrefilter((settings) => {\n    // Assigns as the first try when it doesn't have 'tries' number.\n    settings.tries ??= 1;\n  });\n\n  backbone.ajax = createAjaxWithRetry(backbone);\n\n  backbone.sync = createSyncWithRetry(backbone);\n}\n\nexport default setupBackboneAjaxRetry;\n"],"names":[],"mappings":"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"}